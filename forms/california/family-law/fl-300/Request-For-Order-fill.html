<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fill Form - AI Associate Attorney</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="container mx-auto">
        <div class="flex gap-8">
            <!-- PDF Preview -->
            <div class="w-1/2">
                <div class="bg-white rounded-lg shadow-lg">
                    <div class="h-16 px-6 flex items-center justify-between border-b">
                        <h3 class="font-semibold text-lg" id="formName"></h3>
                        <div class="flex gap-4">
                            <button onclick="downloadPDF()" class="text-blue-600 hover:text-blue-800">Download PDF</button>
                            <a href="/forms" class="text-blue-600 hover:text-blue-800">Back to Forms</a>
                        </div>
                    </div>
                    <div class="h-[calc(100vh-12rem)] p-4">
                        <iframe id="pdfViewer" class="w-full h-full border rounded"></iframe>
                    </div>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div class="w-1/2">
                <div class="bg-white rounded-lg shadow-lg h-full flex flex-col">
                    <div class="h-16 px-6 flex items-center border-b">
                        <h3 class="font-semibold">Chat with AI Assistant</h3>
                    </div>
                    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <!-- Messages will be inserted here -->
                    </div>
                    <div class="border-t p-4">
                        <div class="flex gap-2">
                            <input type="text" id="userInput" 
                                   class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Type your message...">
                            <button onclick="sendMessage()" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get form details from the current URL path
        const pathParts = window.location.pathname.split('/');
        const formId = pathParts[pathParts.length - 2]; // Gets the form directory name (fl-300)
        const formDir = pathParts.slice(1, -1).join('/'); // Gets the directory path (forms/california/family-law/fl-300)
        const pdfPath = `/${formDir}/Request-For-Order-fillable.pdf`;
        
        // Initialize the form
        document.getElementById('formName').textContent = formId.toUpperCase();
        document.getElementById('pdfViewer').src = pdfPath;
        
        // Initialize chat
        document.getElementById('chatMessages').innerHTML = `
            <div class="bg-gray-100 rounded-lg p-4">
                <p class="text-gray-700">Hi! I'll help you fill out this form. What field would you like to fill first?</p>
            </div>
        `;
        
        // Add field mapping and state management
        let currentField = null;
        const fieldMappings = {
            "Name": "FillText123",
            "Firm Name": "FillText122",
            "Street address": "FillText121",
            "City": "FillText120",
            // Add more field mappings as needed
        };

        // Enhanced sendMessage function
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessageToChat(message, 'user');
            userInput.value = '';

            try {
                // Fetch and load PDF
                const existingPdfBytes = await fetch(pdfPath).then(res => res.arrayBuffer());
                const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();
                
                // Get all form fields for debugging
                const fields = form.getFields();
                console.log('Available fields:', fields.map(f => f.getName()));

                if (!currentField) {
                    // If no field is selected, try to identify which field the user wants to fill
                    const fieldMatch = identifyRequestedField(message.toLowerCase());
                    if (fieldMatch) {
                        currentField = fieldMatch;
                        addMessageToChat(`I'll help you fill the ${currentField} field. Please provide the value you'd like to enter.`, 'ai');
                        return;
                    }
                } else {
                    // We have a current field, so let's fill it
                    try {
                        const fieldName = fieldMappings[currentField];
                        const textField = form.getTextField(fieldName);
                        
                        // Validate input before filling
                        const validatedInput = validateFieldInput(currentField, message);
                        if (validatedInput.error) {
                            addMessageToChat(validatedInput.error, 'ai');
                            return;
                        }
                        
                        textField.setText(validatedInput.value);
                        
                        // Save and display the updated PDF
                        const pdfBytes = await pdfDoc.save();
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        const url = URL.createObjectURL(blob);
                        document.getElementById('pdfViewer').src = url;
                        
                        addMessageToChat(`I've updated the ${currentField} field. What else would you like to fill?`, 'ai');
                        currentField = null;
                    } catch (error) {
                        console.error('Error filling field:', error);
                        addMessageToChat(`Sorry, I couldn't fill the ${currentField} field. Please try again.`, 'ai');
                        currentField = null;
                    }
                }
            } catch (error) {
                console.error('Error processing PDF:', error);
                addMessageToChat('Sorry, I encountered an error while processing the form. Please try again.', 'ai');
            }
        }

        // Helper function to add messages to chat
        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageHTML = sender === 'user' 
                ? `<div class="flex justify-end">
                     <div class="bg-blue-600 text-white rounded-lg p-4 max-w-[80%]">
                         <p>${message}</p>
                     </div>
                   </div>`
                : `<div class="bg-gray-100 rounded-lg p-4 max-w-[80%]">
                     <p class="text-gray-700">${message}</p>
                   </div>`;
            
            chatMessages.innerHTML += messageHTML;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Helper function to identify which field the user wants to fill
        function identifyRequestedField(message) {
            const fieldKeywords = {
                name: ['name', 'full name'],
                address: ['address', 'location', 'residence'],
                phone: ['phone', 'telephone', 'contact number'],
                email: ['email', 'e-mail', 'electronic mail']
                // Add more field keywords as needed
            };

            for (const [field, keywords] of Object.entries(fieldKeywords)) {
                if (keywords.some(keyword => message.includes(keyword))) {
                    return field;
                }
            }
            return null;
        }

        // Helper function to validate field input
        function validateFieldInput(field, value) {
            switch (field) {
                case 'phone':
                    const phoneRegex = /^\d{10}$/;
                    if (!phoneRegex.test(value.replace(/\D/g, ''))) {
                        return {
                            error: 'Please provide a valid 10-digit phone number.'
                        };
                    }
                    return { value: value.replace(/\D/g, '') };
                    
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        return {
                            error: 'Please provide a valid email address.'
                        };
                    }
                    return { value };
                    
                default:
                    return { value };
            }
        }

        // Handle enter key
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function downloadPDF() {
            const pdfFrame = document.getElementById('pdfViewer');
            const pdfUrl = pdfFrame.src;
            
            // Create a temporary link element
            const link = document.createElement('a');
            link.href = pdfUrl;
            link.download = 'filled-form.pdf';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
